name: "Platform Repository Rules"
enforcement: "active"
target: "branch"
conditions:
  repository_name:
    - pattern: "alz-platform"
rules:
  # Pull Request Rules - More stringent for platform
  - type: "pull_request"
    parameters:
      required_approving_review_count: 3
      dismiss_stale_reviews_on_push: true
      require_code_owner_review: true
      require_last_push_approval: true
      required_review_thread_resolution: true
  
  # Required Status Checks - Platform specific
  - type: "required_status_checks"
    parameters:
      required_status_checks:
        - context: "platform-ci"
          integration_id: null
        - context: "platform-security-scan"
          integration_id: null
        - context: "platform-compliance-check"
          integration_id: null
        - context: "cross-subscription-validation"
          integration_id: null
      strict_required_status_checks_policy: true
  
  # Branch Protection Rules
  - type: "non_fast_forward"
  
  - type: "required_linear_history"
  
  - type: "required_signatures"
  
  # Deployment Rules - Platform specific
  - type: "required_deployments"
    parameters:
      required_deployment_environments:
        - "platform-staging"
        - "platform-production"
  
  # Additional Pull Request Rules for Platform Branches
  - type: "pull_request"
    parameters:
      required_approving_review_count: 2
      dismiss_stale_reviews_on_push: true
      require_code_owner_review: true
      require_last_push_approval: true
      required_review_thread_resolution: true
    conditions:
      ref_name:
        - pattern: "feature/platform/*"
        - pattern: "hotfix/platform/*"
  
  # Branch Naming Rules - Platform specific
  - type: "branch_name_pattern"
    parameters:
      name:
        - pattern: "main"
        - pattern: "develop"
        - pattern: "feature/platform/*"
        - pattern: "hotfix/platform/*"
        - pattern: "release/platform/*"
  
  # Commit Message Rules - Platform specific
  - type: "commit_message_pattern"
    parameters:
      name:
        - pattern: "^(feat|fix|docs|style|refactor|test|chore)(\\(platform\\))?: .+"
        - pattern: "^(feat|fix|docs|style|refactor|test|chore)(\\(mg|connectivity|identity|security\\))?: .+"
  
  # File Path Rules - Platform specific
  - type: "file_path_restriction"
    parameters:
      restricted_file_paths:
        - "management-groups/**"
        - "connectivity/**"
        - "identity/**"
        - "security/**"
        - "modules/**"
        - "*.tf"
        - "*.tfvars"
        - "*.tfstate"
        - "*.tfstate.backup"
      restricted_file_extensions:
        - ".tf"
        - ".tfvars"
      restricted_file_patterns:
        - "**/management-groups/**"
        - "**/connectivity/**"
        - "**/identity/**"
        - "**/security/**"
        - "**/modules/**"
        - "**/*.tf"
        - "**/*.tfvars"
  
  # Tag Rules - Platform specific
  - type: "tag_name_pattern"
    parameters:
      name:
        - pattern: "platform-v[0-9]+\\.[0-9]+\\.[0-9]+"
        - pattern: "platform-v[0-9]+\\.[0-9]+\\.[0-9]+-.*"
  
  # Workflow Rules - Platform specific
  - type: "workflow"
    parameters:
      workflow_name:
        - pattern: "platform-ci"
        - pattern: "platform-deploy"
        - pattern: "platform-security-scan"
        - pattern: "platform-compliance-check"
        - pattern: "cross-subscription-validation"
  
  # Environment Rules - Platform specific
  - type: "environment"
    parameters:
      environment_name:
        - pattern: "platform-staging"
        - pattern: "platform-production"
  
  # Repository Rules - Platform specific
  - type: "repository"
    parameters:
      repository_name:
        - pattern: "alz-platform"
        - pattern: "infra-ci-templates"
  
  # Team Rules - Platform specific
  - type: "team"
    parameters:
      team_name:
        - pattern: "platform-team"
        - pattern: "devops-team"
        - pattern: "security-team"
        - pattern: "architecture-team"
  
  # User Rules - Platform specific
  - type: "user"
    parameters:
      user_name:
        - pattern: "platform-admin"
        - pattern: "devops"
        - pattern: "platform"
        - pattern: "architecture"
  
  # Additional Platform-specific Rules
  - type: "pull_request"
    parameters:
      required_approving_review_count: 1
      dismiss_stale_reviews_on_push: true
      require_code_owner_review: false
      require_last_push_approval: true
      required_review_thread_resolution: true
    conditions:
      ref_name:
        - pattern: "docs/*"
        - pattern: "examples/*"
  
  # Platform Change Impact Rules
  - type: "pull_request"
    parameters:
      required_approving_review_count: 4
      dismiss_stale_reviews_on_push: true
      require_code_owner_review: true
      require_last_push_approval: true
      required_review_thread_resolution: true
    conditions:
      ref_name:
        - pattern: "feature/platform/major-*"
        - pattern: "feature/platform/breaking-*"
  
  # Emergency Platform Changes
  - type: "pull_request"
    parameters:
      required_approving_review_count: 2
      dismiss_stale_reviews_on_push: true
      require_code_owner_review: true
      require_last_push_approval: true
      required_review_thread_resolution: true
    conditions:
      ref_name:
        - pattern: "hotfix/platform/emergency-*"
        - pattern: "hotfix/platform/security-*"

